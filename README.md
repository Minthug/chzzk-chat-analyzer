# 치지직 채팅 분석기 Chrome 확장 프로그램

> **v1.6.0**

치지직(chzzk.naver.com) VOD와 라이브 방송의 채팅 급증 구간을 자동으로 감지해,
영상 편집자가 편집 포인트를 쉽게 찾을 수 있도록 돕는 Chrome 확장 프로그램.

## 기능

- **채팅 자동 수집**: DOM 감지 방식으로 실시간 채팅 수집 (라이브 / VOD), 닉네임 포함
- **포인트 스파이크 감지**: Z-Score 알고리즘으로 채팅 급증 구간 자동 감지
- **키워드 스파이크 감지**: 사용자 지정 키워드의 급증 구간 별도 감지
- **매니저 채팅 수집**: 매니저 채팅을 별도로 수집해 팝업 매니저 탭에서 확인
- **Top 3 하이라이트**: Z-Score 기준 상위 3개 급증 구간에 ★ 표시 (시간순 정렬 유지)
- **오버레이 그래프**: 비디오 재생바 위에 채팅량 곡선 그래프 표시 (재생바 위치와 정확히 일치)
- **썸네일 미리보기**: 급증 구간 감지 시 해당 시점 화면을 자동 캡처해 팝업에 표시
- **급증 구간 클릭**: 그래프·목록에서 클릭 → 해당 시점으로 영상 이동
- **키보드 단축키**: `+` / `-` 키로 급증 구간 빠르게 탐색
- **자동 저장**: 세션 데이터를 브라우저에 저장 (새로고침 후에도 급증 기록 유지)
- **자동 초기화**: 다른 영상으로 이동하거나 VOD 재생 완료 시 세션 자동 초기화
- **자동 내보내기**: 세션 초기화 전 급증 구간이 있으면 TXT 파일 자동 저장
- **편집 메모**: 각 급증 구간에 메모 추가 — 내보내기 시 함께 포함
- **내보내기**: `.txt` / `.csv` 형식으로 타임스탬프 내보내기

## 설치 방법

1. Chrome 주소창에 `chrome://extensions/` 입력
2. 우측 상단 **개발자 모드** 활성화
3. **압축해제된 확장 프로그램을 로드합니다** 클릭
4. `chzzk-chat-analyzer/` 폴더 선택

## 사용 방법

1. 치지직 라이브 방송 또는 VOD 페이지 접속
2. 채팅이 쌓이면 영상 재생바 위에 그래프가 자동 표시됨
3. 붉은 구간 = 채팅 급증 / 흰색 선 = 일반 채팅량
4. 확장 아이콘 클릭 → 팝업에서 채팅 급증 구간 목록 확인 및 내보내기
5. 목록의 타임스탬프 클릭 → 해당 시점으로 영상 이동
6. 각 급증 구간 옆 썸네일로 해당 시점 화면 미리 확인 가능
7. **포인트 / 키워드 / 매니저** 탭 전환으로 확인
8. 각 구간 아래 메모 입력창에 편집 포인트 메모 작성 (자동저장)

> **⚠️ 새로운 방에 입장했을 때**
> 새로운 라이브 방송이나 VOD에 처음 접속한 경우, **페이지를 새로고침(`F5`)한 뒤 확장 프로그램 팝업을 열어 채팅이 정상적으로 수집되는지 확인**하세요.
> 새로고침 없이 접속하면 채팅 감지가 시작되지 않을 수 있습니다.

## 키보드 단축키

VOD 시청 중 급증 구간을 키보드로 빠르게 탐색할 수 있습니다.

| 키 | 동작 |
|---|---|
| `+` | 다음 급증 구간으로 이동 |
| `-` | 이전 급증 구간으로 이동 |

- 이동 시 화면 상단에 해당 구간 정보 토스트 알림 표시
  ```
  ▶ 00:12:34  245개/30s  Z=3.45
  ```
- 채팅 입력창에 포커스 중일 때는 동작하지 않음
- VOD 전용 기능 (라이브 방송에서는 동작하지 않음)
- `=` / `_` 키도 동일하게 동작 (Shift 없이 입력 가능)

## 키워드 스파이크 감지

볼륨(채팅 수) 기반 감지 외에, 특정 키워드의 빈도 급증도 별도로 감지합니다.

### 사용 방법

1. 팝업 → **키워드 감지** 섹션
2. 입력창에 키워드 입력 후 `Enter` 또는 **추가** 버튼
3. 팝업 상단 **키워드** 탭에서 키워드별 급증 구간 확인

```
키워드 탭 예시:

[ㅋㅋ]  ▶ 00:18:20 ★  42회/30s  Z=5.1
[레전드] ▶ 00:31:44    18회/30s  Z=3.8
[ㅋㅋ]  ▶ 00:44:10    35회/30s  Z=3.2
```

### 포인트 스파이크와의 차이

| | 포인트 탭 | 키워드 탭 |
|---|---|---|
| 감지 기준 | 채팅 수 전체 급증 | 특정 단어 빈도 급증 |
| 특징 | 모든 반응 포착 | 반응의 성격 파악 가능 |
| 예시 | 채팅이 갑자기 3배 증가 | "ㄹㅇ이가?"가 평소보다 5배 등장 |

### 키워드 등록 규칙

- `ㅋ`, `ㅎ`, `ㄷ` 등 **단독 자음/모음은 등록 불가** (거의 모든 채팅에 포함되어 오탐 과다)
- 그 외 1글자(`!`, `?` 등) 및 2글자 이상은 모두 등록 가능
- 부분 문자열 매칭 방식 — `ㅋㅋ` 설정 시 `ㅋㅋㅋㅋ`도 감지
- Z-Score 기반이라 해당 키워드가 평소에 자주 나와도 **상대적 급증**만 감지

### 키워드 추천
- 방송 내용 혹은 게임에 관련된 내용에 적합한 키워드를 설정하면 포인트 잡는데 도움이 될 거라 생각합니다.
| 상황 | 추천 키워드 |
|---|---|
| 웃음 반응 | `ㅋㅋ`, `ㅎㅎ` |
| 감탄 반응 | `ㄹㅇㅋㅋ`, `흠`, `?` |
| 게임 하이라이트 | 게임별 주요 용어 |
| 특정 이벤트 | 방송 내 특정 단어 |

## 매니저 채팅 탭

방송 중 매니저가 보낸 채팅을 별도로 수집해 팝업의 **매니저** 탭에서 모아볼 수 있습니다.

```
매니저 탭 예시:

00:05:12  매니저A  공지: 욕설 및 비방 금지입니다
00:31:44  매니저B  이벤트 참여는 채팅창에 !참여 입력
01:02:10  매니저A  잠시 후 방송 종료 예정입니다
```

- VOD에서는 해당 시점 클릭 시 영상이 해당 위치로 이동
- 최대 300개까지 저장 (초과 시 오래된 항목부터 제거)
- 매니저 뱃지 이미지 경로 기반으로 자동 감지

## Top 3 ★ 하이라이트

급증 구간이 많을 때 Z-Score 기준 상위 3개에 ★ 표시로 핵심 포인트를 빠르게 파악할 수 있습니다.

- 시간순 정렬은 유지되며 ★만 추가 표시
- 포인트 탭과 키워드 탭 모두 적용

## 편집 메모

각 급증 구간 아이템 아래에 메모를 자유롭게 작성할 수 있습니다.

```
┌────────┐  ▶ 00:12:34 ★
│ thumb  │  245개/30s
│        │  Z=3.45
└────────┘  ✏ 웃음 포인트, 클립 가능
```

- 입력 후 **0.8초 뒤 자동저장** (별도 저장 버튼 없음)
- 팝업을 닫아도 메모 유지
- 메모가 있는 구간은 왼쪽 파란 줄로 시각적 구분
- 포인트 탭과 키워드 탭 모두 지원
- TXT / CSV 내보내기 시 메모 내용도 함께 포함

## 자동 초기화 & 자동 내보내기

영상이 끝나거나 다른 영상으로 이동할 때 세션이 자동으로 초기화됩니다.
데이터 손실을 방지하기 위해 **초기화 전 TXT 파일을 자동으로 다운로드**합니다.

| 상황 | 동작 |
|---|---|
| 다른 VOD / 라이브로 이동 | 이전 세션 자동 내보내기 → 초기화 |
| VOD 재생 완료 | 세션 자동 내보내기 → 초기화 |
| 같은 페이지 새로고침 | 세션 유지 |

- 급증 구간이 없으면 파일을 생성하지 않음
- 파일명: `스트리머명_방제_날짜.txt` (chzzk API로 자동 추출, 실패 시 pageId 사용)
- 브라우저 기본 다운로드 폴더에 자동 저장

## 설정

팝업 하단 **설정** 항목에서 아래 값들을 조정할 수 있습니다.

### Z-Score 임계값 (기본값: 3.0)

채팅 급증을 판단하는 민감도 기준입니다.
Z-Score는 현재 구간의 채팅량이 최근 평균보다 얼마나 튀는지를 나타내는 수치입니다.

| 값 | 의미 |
|---|---|
| **2.0** | 민감하게 감지 — 작은 반응도 잡음, 오탐 증가 |
| **3.0** | 기본값 — 일반적인 영상에 적합 |
| **4.0** | 보수적으로 감지 — 확실히 큰 반응만 잡음 |

> **낮출수록** 더 많이 감지 (오탐 ↑) / **높일수록** 덜 감지 (놓침 ↑)
> 채팅이 전반적으로 많은 대형 방송은 **3.5~4.0**, 소규모 방송은 **2.5~3.0** 권장

### 윈도우 크기 (기본값: 30초)

채팅량을 집계하는 시간 단위입니다.
`30초`면 30초마다 채팅 수를 합산해 급증 여부를 판단합니다.

| 값 | 의미 |
|---|---|
| **15초** | 짧은 단위 — 순간적인 반응(짧은 클립)에 민감 |
| **30초** | 기본값 — 대부분의 VOD에 적합 |
| **60초** | 긴 단위 — 전반적인 흐름 파악, 세부 반응은 놓칠 수 있음 |

> 짧은 하이라이트 클립 편집엔 **15~20초**, 장편 VOD 분석엔 **30~45초** 권장

### 설정 적용 방법

1. 팝업 하단 **설정** 섹션에서 값을 변경
2. **설정 저장** 버튼 클릭
3. 변경사항은 즉시 적용됨 (페이지 새로고침 불필요)

## 썸네일 미리보기

급증 구간이 감지되는 순간 해당 시점의 화면을 자동으로 캡처해 팝업 목록에 표시합니다.

```
┌────────┐  ▶ 00:12:34
│ 캡처본 │  245개/30s
│        │  3.2x Z=3.45
└────────┘
```

- 캡처는 `chrome.tabs.captureVisibleTab`을 사용하므로 **치지직 탭이 활성화된 상태**일 때만 동작
- 탭이 백그라운드에 있을 때 감지된 급증 구간은 📷 플레이스홀더로 표시
- 썸네일은 `chrome.storage.local`에 자동 저장 (새로고침 후에도 유지)

## 알고리즘

```
windowSize = 30초 (설정 가능)
lag        = 최근 10개 윈도우를 기준선으로 사용

mean  = 최근 10개 윈도우의 채팅수(또는 키워드 빈도) 평균
std   = 최근 10개 윈도우의 표준편차
Z     = (현재 윈도우 값 - mean) / std

Z >= threshold → 급증 구간으로 판정
```

볼륨 스파이크와 키워드 스파이크 모두 동일한 Z-Score 알고리즘으로 감지합니다.

## 내보내기 형식

**.txt**
```
# 치지직 편집 포인트 | 채팅 급증 구간
# 페이지 ID: xxxxxx  |  생성: 2024-01-01 12:00:00

00:12:34 [포인트] - 245개/30s, 평균 대비 3.2x, Z=3.45 // 웃음 포인트
00:28:15 [포인트] - 312개/30s, 평균 대비 4.1x, Z=4.12
00:31:44 [키워드:레전드] - 18회/30s, 평균 대비 5.0x, Z=3.8
```

**.csv**
```
timestamp_hms,timestamp_sec,chat_count,avg_count,spike_ratio,z_score,memo
00:12:34,754,245,76.2,3.21,3.45,"웃음 포인트"
00:28:15,1695,312,76.2,4.10,4.12,
```

## 버전 히스토리

| 버전 | 주요 변경 |
|---|---|
| **v1.6.0** | 매니저 채팅 탭 추가, 파일명 스트리머명\_방제\_날짜 형식, 스파이크 레이블 포인트로 변경, 닉네임 포함 채팅 수집, 새로고침 안내 UI |
| **v1.5.0** | 자동 초기화 및 자동 TXT 내보내기, 메모 UI 개선, 카카오페이 후원 버튼, 타임라인 정렬 수정 |
| **v1.4.1** | 라이브 방송 채팅 수집 선택자 버그 수정 (채팅 감지 불가 문제 해결) |
| **v1.4.0** | 편집 메모 기능, 키워드 자음/모음 등록 제한, 내보내기에 메모 포함 |
| **v1.3.0** | 키워드 스파이크 감지, 볼륨/키워드 탭 분리, Top 3 ★ 하이라이트, 버튼 레이아웃 개선 |
| **v1.2.2** | +/- 키보드 단축키로 급증 구간 탐색 기능 추가 |
| **v1.2.1** | SAVE_SETTINGS 구문 오류 핫픽스 (서비스 워커 등록 실패 수정) |
| **v1.2.0** | 급증 구간 썸네일 자동 캡처 및 팝업 표시, 스토리지 사용량 표시, 썸네일 ON/OFF 설정 |
| **v1.1.0** | 재생바 그래프 시간축 정확도 개선, 설정 가이드 추가 |
| **v1.0.0** | 최초 릴리즈 |

## 구조

```
chzzk-chat-analyzer/
├── manifest.json
├── src/
│   ├── background/background.js   # 스파이크 감지 엔진 + 데이터 저장
│   ├── content/
│   │   ├── page-inject.js         # MAIN world - WebSocket 폴백 (탭 숨김 시)
│   │   ├── content.js             # ISOLATED world - DOM 채팅 수집 코디네이터
│   │   └── overlay.js             # 재생바 위 채팅량 그래프 오버레이
│   └── popup/
│       ├── popup.html
│       └── popup.js
└── icons/icon128.png
```
